# Story 1.6: Universal Links / App Links Authentication

## Status
Ready for Implementation (Infrastructure Setup Required)

**Domain:** `TodoTomorrow.com` (configured)
**App Details:**
- iOS Bundle ID: `com.todotomorrow.app`
- Android Package: `com.todotomorrow.app`
- App Name: TodoTomorrow

**Note:** This story addresses limitations discovered in Story 1.4 (custom URL schemes). Infrastructure setup instructions provided below.

## Story
**As a** user,  
**I want to** click the magic link in my email and have it open the app reliably,  
**so that** I can authenticate without encountering browser security issues or white screens

## Acceptance Criteria
1. Domain purchased and configured for Universal Links / App Links (`TodoTomorrow.com`)
2. Web redirect page hosted at `https://todotomorrow.com/auth/callback`
3. iOS Universal Links configured with `apple-app-site-association` file
4. Android App Links configured with `assetlinks.json` file
5. Supabase redirect URL updated to use web URL instead of custom scheme
6. Deep link handler updated to support Universal Links / App Links
7. Magic link flow works end-to-end from email click to app authentication
8. Fallback page displays "Open in app" button if app not installed

## Tasks / Subtasks
- [ ] Domain and Hosting Setup (AC: 1, 2)
  - [x] Domain: `TodoTomorrow.com` (purchased and configured)
  - [ ] Configure domain DNS to point to Cloudways server (see Infrastructure Setup section)
  - [ ] Set up HTTPS/SSL certificate on Cloudways (see Infrastructure Setup section)
  - [ ] Create web directory structure on server
  - [ ] Create redirect page at `https://todotomorrow.com/auth/callback`
  - [ ] Redirect page extracts token from URL query parameters
  - [ ] Redirect page detects mobile device and redirects to app
  - [ ] Fallback page created for non-mobile or if app not installed

- [ ] iOS Universal Links Configuration (AC: 3)
  - [ ] Add Associated Domains capability in `app.json` or `app.config.js`
  - [ ] Configure `applinks:todotomorrow.com` in Associated Domains
  - [ ] Create `apple-app-site-association` file (bundle ID: `com.todotomorrow.app`)
  - [ ] Host file at `https://todotomorrow.com/.well-known/apple-app-site-association`
  - [ ] File must be served with `Content-Type: application/json`
  - [ ] File must be accessible without authentication
  - [ ] Configure file with app bundle ID (`com.todotomorrow.app`) and paths
  - [ ] Test Universal Links on iOS device

- [ ] Android App Links Configuration (AC: 4)
  - [ ] Add intent filters in `app.json` for Android
  - [ ] Configure `android.intent.action.VIEW` intent filter
  - [ ] Configure `android.intent.category.BROWSABLE` category
  - [ ] Configure `android.intent.category.DEFAULT` category
  - [ ] Add data scheme: `https` and host: `todotomorrow.com`
  - [ ] Create `assetlinks.json` file
  - [ ] Host file at `https://todotomorrow.com/.well-known/assetlinks.json`
  - [ ] File must be served with `Content-Type: application/json`
  - [ ] Generate app signing certificate SHA-256 fingerprint
  - [ ] Add fingerprint to `assetlinks.json` with package name (`com.todotomorrow.app`)
  - [ ] Test App Links on Android device

- [ ] Update Supabase Configuration (AC: 5)
  - [ ] Update Supabase Dashboard → Authentication → URL Configuration
  - [ ] Add redirect URL: `https://todotomorrow.com/auth/callback`
  - [ ] Remove or keep custom scheme URL (for fallback)
  - [ ] Update magic link API call in AuthScreen to use web URL
  - [ ] Test that email links contain new redirect URL

- [ ] Update Deep Link Handler (AC: 6)
  - [ ] Update AuthScreen deep link handler to support Universal Links format
  - [ ] Handler should accept both `https://todotomorrow.com/auth/callback?token=...` and `todotomorrow://auth/callback?token=...`
  - [ ] Extract token from Universal Link URL format
  - [ ] Verify token with Supabase
  - [ ] Handle session creation
  - [ ] Test handler with both URL formats

- [ ] End-to-End Testing (AC: 7, 8)
  - [ ] Test magic link email contains correct redirect URL
  - [ ] Test clicking link in email opens app (iOS)
  - [ ] Test clicking link in email opens app (Android)
  - [ ] Test authentication completes successfully
  - [ ] Test session is created and stored
  - [ ] Test fallback page displays when app not installed
  - [ ] Test fallback page "Open in app" button works
  - [ ] Test deep link handler logs show correct processing

## Dev Notes

### Story Context & Scope

**Why This Story Exists:**
- Story 1.4 (Magic Link Authentication) identified limitations with custom URL schemes (`todotomorrow://`)
- Custom schemes don't work in Expo Go and have browser security limitations
- Universal Links / App Links provide the production-ready solution

**Infrastructure Requirements:**
- ✅ **Domain:** `TodoTomorrow.com` (configured)
- ⚠️ **Requires web hosting** (Cloudways server - setup instructions below)
- ⚠️ **Requires HTTPS/SSL setup** (via Cloudways)
- ⚠️ **Requires DNS configuration** (point to Cloudways server)

**Epic Placement:**
- This story is part of Epic 1 but requires infrastructure setup beyond typical Epic 1 scope
- Can be implemented post-MVP if domain/hosting not yet available
- Story 1.4 works for MVP with custom schemes in production builds

### Previous Story Insights
[Source: Story 1.4 completion notes]

**Key Learnings from Story 1.4:**
- Magic link authentication flow is implemented and working
- Deep link handler correctly extracts tokens and verifies with Supabase
- Custom URL schemes (`todotomorrow://`) don't work in Expo Go (limitation)
- Custom schemes have browser security limitations
- Universal Links / App Links recommended for production use
- Code structure supports adding Universal Links support

**Current Implementation:**
- AuthScreen component exists with deep link handler
- Handler supports `todotomorrow://auth/callback?token=...&type=magiclink`
- Token verification logic works correctly
- Session creation works
- Error handling is comprehensive

### Universal Links / App Links Architecture
[Source: Expo documentation, iOS/Android platform guides]

**Universal Links (iOS):**
- iOS 9+ feature for deep linking
- Requires Associated Domains capability
- Uses `apple-app-site-association` file
- File must be served over HTTPS
- File must be JSON format (no `.json` extension)
- Automatically handles fallback to web if app not installed

**App Links (Android):**
- Android 6.0+ feature for deep linking
- Requires intent filters in manifest
- Uses `assetlinks.json` file
- File must be served over HTTPS
- Requires app signing certificate fingerprint
- Handles verification automatically

**Expo Configuration:**
- Expo supports Universal Links / App Links via `app.json`
- Associated Domains configured under `ios.associatedDomains`
- Android intent filters configured under `android.intentFilters`
- Expo handles native configuration automatically

### Web Redirect Page Implementation
[Source: Common Universal Links patterns]

**Redirect Page Requirements:**
- Must be accessible at `https://todotomorrow.com/auth/callback`
- Must extract token from query parameters: `?token=XXX&type=magiclink`
- Must detect if request is from mobile device
- Must redirect to app if mobile device detected
- Must show fallback page if app not installed or desktop

**Redirect Page Flow:**
1. User clicks email link → Supabase redirects to `https://todotomorrow.com/auth/callback?token=...`
2. Page loads and extracts token from URL
3. Detects user agent (mobile vs desktop)
4. If mobile: Redirects to app via Universal Link / App Link (`https://todotomorrow.com/auth/callback?token=...`)
5. If desktop or app not installed: Shows "Open in app" page with manual deep link (`todotomorrow://auth/callback?token=...`)

**Implementation Options:**
- Static HTML page with JavaScript redirect (recommended for simplicity)
- PHP page for server-side detection (if PHP is available on Cloudways)
- Simple page that works on Cloudways hosting

### Supabase Redirect URL Configuration
[Source: Supabase authentication documentation]

**Required Configuration:**
- Supabase Dashboard → Authentication → URL Configuration
- Add redirect URL: `https://todotomorrow.com/auth/callback`
- Keep `todotomorrow://auth/callback` for backward compatibility (fallback)
- Email links will now redirect to web URL first, then to app

**Code Changes:**
```typescript
// Update in src/screens/AuthScreen.tsx
supabase.auth.signInWithOtp({
  email: email.trim(),
  options: {
    emailRedirectTo: 'https://todotomorrow.com/auth/callback', // Changed from todotomorrow:// (custom scheme fallback)
  },
})
```

### Deep Link Handler Updates
[Source: Story 1.4 implementation]

**Current Handler:**
- Handles `todotomorrow://auth/callback?token=...`
- Extracts token and type from query parameters
- Verifies with Supabase
- Creates session

**Required Updates:**
- Also handle `https://todotomorrow.com/auth/callback?token=...`
- Same token extraction logic
- Same verification flow
- Maintain backward compatibility with custom scheme (`todotomorrow://auth/callback?token=...`)

**Implementation:**
```typescript
// Handler should accept both formats
const isAuthCallback = 
  (parsedUrl.scheme === 'todotomorrow' && parsedUrl.path === 'auth/callback') || // Custom scheme
  (parsedUrl.hostname === 'todotomorrow.com' && parsedUrl.path === '/auth/callback'); // Universal Link
```

### Cloudways Server Setup
[Source: Cloudways documentation, general web hosting]

**Prerequisites:**
- Cloudways account created
- `TodoTomorrow.com` domain purchased
- Domain registrar access (for DNS configuration)

**Step-by-Step Setup Instructions:**

#### Step 1: Create Cloudways Server
1. Log in to Cloudways Dashboard: https://platform.cloudways.com/
2. Click **"Launch Now"** or **"Add Server"**
3. **Server Details:**
   - **Cloud Provider:** Choose DigitalOcean, AWS, or Google Cloud (DigitalOcean is most cost-effective)
   - **Server Size:** Select smallest size (1GB RAM is sufficient for static hosting)
   - **Location:** Choose closest to your users
   - **Server Name:** `todotomorrow` or similar
4. Click **"Launch Now"** and wait for server to be provisioned (5-10 minutes)

#### Step 2: Add Application
1. Once server is ready, click **"Add Application"**
2. **Application Details:**
   - **Application Name:** `todotomorrow-app` or similar
   - **PHP Version:** 8.1 or 8.2 (for static files, version doesn't matter)
   - **Project Name:** Same as application name
3. Click **"Add Application"**
4. Note the **Application URL** (will be something like `todotomorrow-app-12345.cloudwaysapps.com`)

#### Step 3: Configure Domain DNS
1. In Cloudways, go to your **Application** → **Domain Management**
2. Click **"Add Domain"**
3. Enter: `todotomorrow.com` (without www)
4. Cloudways will show you the **IP address** to point your domain to
5. **In your domain registrar (where you bought TodoTomorrow.com):**
   - Go to DNS management
   - Add an **A record:**
     - **Name/Host:** `@` (or leave blank)
     - **Type:** `A`
     - **Value/IP:** (the IP address Cloudways provided)
     - **TTL:** 3600 (or default)
   - Optionally add **www** subdomain:
     - **Name/Host:** `www`
     - **Type:** `A`
     - **Value/IP:** (same IP address)
6. **Wait for DNS propagation** (can take 5 minutes to 48 hours, usually 15-30 minutes)

#### Step 4: Install SSL Certificate
1. In Cloudways, go to **Application** → **SSL Certificate**
2. Click **"Let's Encrypt"** tab
3. Enter email address (for certificate expiration notifications)
4. Select domain: `todotomorrow.com`
5. Click **"Install Certificate"**
6. Wait for installation (1-2 minutes)
7. **Enable HTTPS Redirect:** Toggle "Force HTTPS" to ON

#### Step 5: Verify Domain Access
1. Once DNS propagates, test:
   - `https://todotomorrow.com` should load (may show default Cloudways page initially)
   - SSL certificate should be valid (green lock icon)

#### Step 6: Access File Manager
1. In Cloudways Dashboard → **Application** → **Access Details**
2. Click **"Launch SSH Terminal"** OR use **SFTP credentials:**
   - **SFTP Host:** (shown in Access Details)
   - **SFTP Username:** (shown in Access Details)
   - **SFTP Password:** (click "Reset Password" to generate)
   - **SFTP Port:** 22
3. **OR use Cloudways File Manager:**
   - Go to **Application** → **File Manager**
   - Navigate to `public_html` directory (this is the web root)

**File Structure:**
```
public_html/
├── auth/
│   └── callback/
│       └── index.html (redirect page)
└── .well-known/
    ├── apple-app-site-association (no extension)
    └── assetlinks.json
```

**Requirements:**
- Domain DNS configured to point to Cloudways server IP
- HTTPS/SSL certificate configured (Let's Encrypt via Cloudways)
- Web server configured (Apache/Nginx - automatically handled by Cloudways)
- `.well-known` directory accessible (create in public_html)
- Static files served correctly

### Testing Requirements
[Source: Story 1.4 testing experience]

**Testing Approach:**
- Manual testing on iOS device (physical device recommended)
- Manual testing on Android device (physical device recommended)
- Test with app installed and not installed
- Test from various email clients (Gmail, iOS Mail, Outlook)
- Test Universal Link verification tools
- Test App Link verification tools

**iOS Testing:**
- Use Universal Links Tester (browser tool)
- Verify `apple-app-site-association` file accessible
- Test on physical iOS device
- Check iOS settings → Associated Domains

**Android Testing:**
- Use App Links Tester (Google tool)
- Verify `assetlinks.json` file accessible
- Test on physical Android device
- Check Android App Links verification

## Testing
**Manual Test Steps:**
1. Send magic link email from app
2. Verify email contains redirect URL: `https://todotomorrow.com/auth/callback?...`
3. Click link in email on iOS device → App should open automatically
4. Click link in email on Android device → App should open automatically
5. Verify authentication completes → "Successfully signed in!" message
6. Check Supabase Dashboard → Authentication → Users (user should be created)
7. Test fallback: Uninstall app, click link → Should show "Open in app" page
8. Test Universal Link verification tools → Should pass
9. Test App Link verification tools → Should pass

**Success Criteria:**
- Email links redirect to web URL (not custom scheme)
- Universal Links open app on iOS automatically
- App Links open app on Android automatically
- Authentication flow completes successfully
- No white screens or browser errors
- Fallback page displays correctly when app not installed
- Verification tools confirm configuration is correct

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-31 | | Initial story creation (incorrectly numbered as 1.5) | Dev Agent |
| 2025-01-31 | | Renumbered to 1.6, updated to reflect enhancement status and infrastructure requirements | Scrum Master |
| 2025-01-31 | | Updated with actual domain (TodoTomorrow.com), app bundle IDs, and comprehensive Cloudways setup instructions | Scrum Master |

## Dev Agent Record

### Agent Model Used
_(To be filled by Dev Agent)_

### Debug Log References
_(To be filled by Dev Agent)_

### Completion Notes List
_(To be filled by Dev Agent)_

### File List
_(To be filled by Dev Agent)_

