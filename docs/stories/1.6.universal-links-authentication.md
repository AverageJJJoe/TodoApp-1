# Story 1.6: Universal Links / App Links Authentication

## Status
Draft (Enhancement Story - Requires Infrastructure Setup)

**Note:** This story addresses limitations discovered in Story 1.4 (custom URL schemes). It requires domain purchase and web hosting infrastructure, which is outside Epic 1's core scope. Story 1.5 is reserved for "Session Management & Protected Routes" per PRD Epic 1 plan.

## Story
**As a** user,  
**I want to** click the magic link in my email and have it open the app reliably,  
**so that** I can authenticate without encountering browser security issues or white screens

## Acceptance Criteria
1. Domain purchased and configured for Universal Links / App Links
2. Web redirect page hosted at `https://yourdomain.com/auth/callback`
3. iOS Universal Links configured with `apple-app-site-association` file
4. Android App Links configured with `assetlinks.json` file
5. Supabase redirect URL updated to use web URL instead of custom scheme
6. Deep link handler updated to support Universal Links / App Links
7. Magic link flow works end-to-end from email click to app authentication
8. Fallback page displays "Open in app" button if app not installed

## Tasks / Subtasks
- [ ] Domain and Hosting Setup (AC: 1, 2)
  - [ ] Purchase domain for app (e.g., `todomorning.app` or similar)
  - [ ] Configure domain DNS to point to Cloudways server
  - [ ] Set up HTTPS/SSL certificate on Cloudways
  - [ ] Create web directory structure on server
  - [ ] Create redirect page at `https://yourdomain.com/auth/callback`
  - [ ] Redirect page extracts token from URL query parameters
  - [ ] Redirect page detects mobile device and redirects to app
  - [ ] Fallback page created for non-mobile or if app not installed

- [ ] iOS Universal Links Configuration (AC: 3)
  - [ ] Add Associated Domains capability in `app.json` or `app.config.js`
  - [ ] Configure `applinks:yourdomain.com` in Associated Domains
  - [ ] Create `apple-app-site-association` file
  - [ ] Host file at `https://yourdomain.com/.well-known/apple-app-site-association`
  - [ ] File must be served with `Content-Type: application/json`
  - [ ] File must be accessible without authentication
  - [ ] Configure file with app bundle ID and paths
  - [ ] Test Universal Links on iOS device

- [ ] Android App Links Configuration (AC: 4)
  - [ ] Add intent filters in `app.json` for Android
  - [ ] Configure `android.intent.action.VIEW` intent filter
  - [ ] Configure `android.intent.category.BROWSABLE` category
  - [ ] Configure `android.intent.category.DEFAULT` category
  - [ ] Add data scheme: `https` and host: `yourdomain.com`
  - [ ] Create `assetlinks.json` file
  - [ ] Host file at `https://yourdomain.com/.well-known/assetlinks.json`
  - [ ] File must be served with `Content-Type: application/json`
  - [ ] Generate app signing certificate SHA-256 fingerprint
  - [ ] Add fingerprint to `assetlinks.json` with package name
  - [ ] Test App Links on Android device

- [ ] Update Supabase Configuration (AC: 5)
  - [ ] Update Supabase Dashboard → Authentication → URL Configuration
  - [ ] Add redirect URL: `https://yourdomain.com/auth/callback`
  - [ ] Remove or keep custom scheme URL (for fallback)
  - [ ] Update magic link API call in AuthScreen to use web URL
  - [ ] Test that email links contain new redirect URL

- [ ] Update Deep Link Handler (AC: 6)
  - [ ] Update AuthScreen deep link handler to support Universal Links format
  - [ ] Handler should accept both `https://yourdomain.com/auth/callback?token=...` and `todomorning://auth/callback?token=...`
  - [ ] Extract token from Universal Link URL format
  - [ ] Verify token with Supabase
  - [ ] Handle session creation
  - [ ] Test handler with both URL formats

- [ ] End-to-End Testing (AC: 7, 8)
  - [ ] Test magic link email contains correct redirect URL
  - [ ] Test clicking link in email opens app (iOS)
  - [ ] Test clicking link in email opens app (Android)
  - [ ] Test authentication completes successfully
  - [ ] Test session is created and stored
  - [ ] Test fallback page displays when app not installed
  - [ ] Test fallback page "Open in app" button works
  - [ ] Test deep link handler logs show correct processing

## Dev Notes

### Story Context & Scope

**Why This Story Exists:**
- Story 1.4 (Magic Link Authentication) identified limitations with custom URL schemes (`todomorning://`)
- Custom schemes don't work in Expo Go and have browser security limitations
- Universal Links / App Links provide the production-ready solution

**Infrastructure Requirements:**
- ⚠️ **Requires domain purchase** (e.g., `todomorning.app`)
- ⚠️ **Requires web hosting** (Cloudways server referenced in story)
- ⚠️ **Requires HTTPS/SSL setup**
- ⚠️ **Requires DNS configuration**

**Epic Placement:**
- This story is part of Epic 1 but requires infrastructure setup beyond typical Epic 1 scope
- Can be implemented post-MVP if domain/hosting not yet available
- Story 1.4 works for MVP with custom schemes in production builds

### Previous Story Insights
[Source: Story 1.4 completion notes]

**Key Learnings from Story 1.4:**
- Magic link authentication flow is implemented and working
- Deep link handler correctly extracts tokens and verifies with Supabase
- Custom URL schemes (`todomorning://`) don't work in Expo Go (limitation)
- Custom schemes have browser security limitations
- Universal Links / App Links recommended for production use
- Code structure supports adding Universal Links support

**Current Implementation:**
- AuthScreen component exists with deep link handler
- Handler supports `todomorning://auth/callback?token=...&type=magiclink`
- Token verification logic works correctly
- Session creation works
- Error handling is comprehensive

### Universal Links / App Links Architecture
[Source: Expo documentation, iOS/Android platform guides]

**Universal Links (iOS):**
- iOS 9+ feature for deep linking
- Requires Associated Domains capability
- Uses `apple-app-site-association` file
- File must be served over HTTPS
- File must be JSON format (no `.json` extension)
- Automatically handles fallback to web if app not installed

**App Links (Android):**
- Android 6.0+ feature for deep linking
- Requires intent filters in manifest
- Uses `assetlinks.json` file
- File must be served over HTTPS
- Requires app signing certificate fingerprint
- Handles verification automatically

**Expo Configuration:**
- Expo supports Universal Links / App Links via `app.json`
- Associated Domains configured under `ios.associatedDomains`
- Android intent filters configured under `android.intentFilters`
- Expo handles native configuration automatically

### Web Redirect Page Implementation
[Source: Common Universal Links patterns]

**Redirect Page Requirements:**
- Must be accessible at `https://yourdomain.com/auth/callback`
- Must extract token from query parameters: `?token=XXX&type=magiclink`
- Must detect if request is from mobile device
- Must redirect to app if mobile device detected
- Must show fallback page if app not installed or desktop

**Redirect Page Flow:**
1. User clicks email link → Supabase redirects to `https://yourdomain.com/auth/callback?token=...`
2. Page loads and extracts token from URL
3. Detects user agent (mobile vs desktop)
4. If mobile: Redirects to app via Universal Link / App Link
5. If desktop or app not installed: Shows "Open in app" page with manual deep link

**Implementation Options:**
- Static HTML page with JavaScript redirect
- PHP/Node.js page for server-side detection
- Simple page that works on Cloudways hosting

### Supabase Redirect URL Configuration
[Source: Supabase authentication documentation]

**Required Configuration:**
- Supabase Dashboard → Authentication → URL Configuration
- Add redirect URL: `https://yourdomain.com/auth/callback`
- This replaces the `todomorning://auth/callback` custom scheme URL
- Email links will now redirect to web URL first, then to app

**Code Changes:**
```typescript
// Update in src/screens/AuthScreen.tsx
supabase.auth.signInWithOtp({
  email: email.trim(),
  options: {
    emailRedirectTo: 'https://yourdomain.com/auth/callback', // Changed from todomorning://
  },
})
```

### Deep Link Handler Updates
[Source: Story 1.4 implementation]

**Current Handler:**
- Handles `todomorning://auth/callback?token=...`
- Extracts token and type from query parameters
- Verifies with Supabase
- Creates session

**Required Updates:**
- Also handle `https://yourdomain.com/auth/callback?token=...`
- Same token extraction logic
- Same verification flow
- Maintain backward compatibility with custom scheme (if needed)

**Implementation:**
```typescript
// Handler should accept both formats
const isAuthCallback = 
  parsedUrl.path === 'auth/callback' || // Custom scheme
  parsedUrl.hostname === 'yourdomain.com' && parsedUrl.path === '/auth/callback'; // Universal Link
```

### Cloudways Server Setup
[Source: Cloudways documentation, general web hosting]

**Requirements:**
- Domain DNS configured to point to Cloudways server IP
- HTTPS/SSL certificate configured (Let's Encrypt via Cloudways)
- Web server configured (Apache/Nginx)
- `.well-known` directory accessible
- Static files served correctly

**File Structure:**
```
/
├── auth/
│   └── callback/
│       └── index.html (or callback.php)
└── .well-known/
    ├── apple-app-site-association
    └── assetlinks.json
```

### Testing Requirements
[Source: Story 1.4 testing experience]

**Testing Approach:**
- Manual testing on iOS device (physical device recommended)
- Manual testing on Android device (physical device recommended)
- Test with app installed and not installed
- Test from various email clients (Gmail, iOS Mail, Outlook)
- Test Universal Link verification tools
- Test App Link verification tools

**iOS Testing:**
- Use Universal Links Tester (browser tool)
- Verify `apple-app-site-association` file accessible
- Test on physical iOS device
- Check iOS settings → Associated Domains

**Android Testing:**
- Use App Links Tester (Google tool)
- Verify `assetlinks.json` file accessible
- Test on physical Android device
- Check Android App Links verification

## Testing
**Manual Test Steps:**
1. Send magic link email from app
2. Verify email contains redirect URL: `https://yourdomain.com/auth/callback?...`
3. Click link in email on iOS device → App should open automatically
4. Click link in email on Android device → App should open automatically
5. Verify authentication completes → "Successfully signed in!" message
6. Check Supabase Dashboard → Authentication → Users (user should be created)
7. Test fallback: Uninstall app, click link → Should show "Open in app" page
8. Test Universal Link verification tools → Should pass
9. Test App Link verification tools → Should pass

**Success Criteria:**
- Email links redirect to web URL (not custom scheme)
- Universal Links open app on iOS automatically
- App Links open app on Android automatically
- Authentication flow completes successfully
- No white screens or browser errors
- Fallback page displays correctly when app not installed
- Verification tools confirm configuration is correct

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-31 | | Initial story creation (incorrectly numbered as 1.5) | Dev Agent |
| 2025-01-31 | | Renumbered to 1.6, updated to reflect enhancement status and infrastructure requirements | Scrum Master |

## Dev Agent Record

### Agent Model Used
_(To be filled by Dev Agent)_

### Debug Log References
_(To be filled by Dev Agent)_

### Completion Notes List
_(To be filled by Dev Agent)_

### File List
_(To be filled by Dev Agent)_

