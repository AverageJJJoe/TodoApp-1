# Story 2.5: Delete Task

## Status
Approved

## Story
**As a** user,  
**I want to** delete tasks I no longer need,  
**So that** I can keep my list clean

## Acceptance Criteria
1. Swipe left on task reveals red "Delete" button
2. Tapping Delete shows confirmation alert
3. Confirming calls: `UPDATE tasks SET deleted_at = NOW() WHERE id = ?`
4. Task removed from local state immediately (optimistic update)
5. If delete fails → Show error, restore task to list

## Tasks / Subtasks
- [ ] Add `deleteTask` function to task store (AC: 3, 4, 5)
  - [ ] Modify `TaskStore` interface to include `deleteTask: (id: string) => Promise<void>` action
  - [ ] Import `supabase` client from `src/lib/supabase` (already imported)
  - [ ] Get `session` from `useAuthStore.getState().session`
  - [ ] Check if `session?.user?.id` exists, throw error if not
  - [ ] Query Supabase to soft delete task:
    - Query: `supabase.from('tasks').update({ deleted_at: new Date().toISOString() }).eq('id', id)`
    - Handle query result: Check for `error` property
    - If error: Throw error for UI handling
    - If success: Task is soft-deleted (no need to check data response for UPDATE)
  - [ ] Note: Soft delete pattern (UPDATE deleted_at) instead of hard delete (DELETE) - preserves data for audit/recovery
- [ ] Implement optimistic update in task store (AC: 4)
  - [ ] Remove task from local state immediately (before Supabase call completes)
  - [ ] Store original task in temporary variable for rollback if delete fails
  - [ ] Update store: `set((state) => ({ tasks: state.tasks.filter((t) => t.id !== id) }))`
  - [ ] If Supabase call fails: Restore task to list using stored original task
  - [ ] Error handling: Catch error, restore task: `set((state) => ({ tasks: [...state.tasks, originalTask].sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime()) }))`
- [ ] Implement swipe gesture in MainScreen (AC: 1)
  - [ ] Install `react-native-gesture-handler` if not already installed (check package.json)
  - [ ] Import `Swipeable` from `react-native-gesture-handler`
  - [ ] Wrap task item in `Swipeable` component in `renderTaskItem` function
  - [ ] Configure `renderRightActions` prop to show red "Delete" button
  - [ ] Style delete button: Red background (`#dc2626`), white text, full height
  - [ ] Add `onSwipeableOpen` handler to track which item is swiped (optional, for UX improvements)
  - [ ] Ensure swipe gesture doesn't conflict with FlatList scroll
- [ ] Add confirmation alert before deletion (AC: 2)
  - [ ] Create `handleDeleteTask` function in MainScreen
  - [ ] Use `Alert.alert()` with confirmation dialog:
    - Title: "Delete Task"
    - Message: "Are you sure you want to delete this task?"
    - Buttons: [{ text: 'Cancel', style: 'cancel' }, { text: 'Delete', style: 'destructive', onPress: () => deleteTask(id) }]
  - [ ] Call `handleDeleteTask` when delete button is tapped in swipe gesture
  - [ ] Pass task `id` to `handleDeleteTask` function
- [ ] Integrate deleteTask with swipe gesture (AC: 1, 2, 3, 4)
  - [ ] Get `deleteTask` function from task store: `const deleteTask = useTaskStore((state) => state.deleteTask)`
  - [ ] Call `deleteTask(id)` in confirmation alert's Delete button `onPress` handler
  - [ ] Handle errors: Catch error from `deleteTask`, show error alert using `Alert.alert()`
  - [ ] Error message: "Failed to delete task. Please try again."
  - [ ] Note: Task will be automatically restored to list by store's error handling (rollback)
- [ ] Close swipe gesture after delete (AC: 1)
  - [ ] Use `useRef` to track `Swipeable` refs: `const swipeableRefs = useRef<Map<string, Swipeable>>(new Map())`
  - [ ] Store ref in `renderItem`: `ref={(ref) => { if (ref) swipeableRefs.current.set(item.id, ref) }}`
  - [ ] After successful delete, close swipe: `swipeableRefs.current.get(id)?.close()`
  - [ ] Alternative: If refs pattern is complex, let swipe close naturally on next interaction (acceptable for MVP)

## Dev Notes

### Previous Story Insights
[Source: Story 2.4 completion notes]

**Key Learnings from Story 2.4:**
- Task store has `loadTasks` function that queries Supabase with `deleted_at IS NULL` filter
- Tasks are loaded from Supabase on app open and filtered to exclude soft-deleted tasks
- Task store pattern established: Zustand store with async actions, error handling via try/catch
- Loading and error states are managed in store (`isLoading`, `loadError`)
- User ID resolution pattern: Query `users` table with `auth_id = session.user.id` to get `user_id`
- MainScreen uses FlatList to display tasks, with pull-to-refresh functionality

**Current Implementation:**
- `src/stores/taskStore.ts` - Has `addTask` and `loadTasks`, needs `deleteTask` function
- `src/stores/authStore.ts` - Provides `session` state with authenticated user information
- `src/screens/MainScreen.tsx` - Displays tasks in FlatList, has task creation modal
- `src/lib/supabase.ts` - Supabase client configured and ready for database operations
- Migration file: `supabase/migrations/002_tasks_table.sql` - Tasks table exists with RLS policies including UPDATE policy

### Database Schema Context
[Source: architecture/database-schema-data-model.md, supabase/migrations/002_tasks_table.sql]

**Tasks Table Schema:**
The tasks table includes `deleted_at` field for soft delete:
- `deleted_at TIMESTAMP DEFAULT NULL` - Soft delete timestamp (NULL if not deleted)
- When `deleted_at` is set, the task is considered deleted (soft delete pattern)

**Soft Delete Pattern:**
[Source: architecture/database-schema-data-model.md, supabase/migrations/002_tasks_table.sql]

Soft delete (setting `deleted_at` timestamp) is used instead of hard delete:
- **Advantages**: Preserves data for audit trail, allows recovery, maintains referential integrity
- **Implementation**: `UPDATE tasks SET deleted_at = NOW() WHERE id = ?`
- **Query Filter**: `loadTasks` already filters with `.is('deleted_at', null)` to exclude deleted tasks
- **Permanent Delete**: Hard delete (actual DELETE) can be implemented later via admin function or scheduled cleanup job

**Row-Level Security (RLS):**
[Source: supabase/migrations/002_tasks_table.sql]

The tasks table has RLS enabled with the following UPDATE policy:
```sql
CREATE POLICY "tasks_update_own" ON tasks
  FOR UPDATE 
  USING (EXISTS (SELECT 1 FROM users WHERE users.id = tasks.user_id AND users.auth_id = auth.uid()))
  WITH CHECK (EXISTS (SELECT 1 FROM users WHERE users.id = tasks.user_id AND users.auth_id = auth.uid()));
```

This means:
- Supabase automatically validates that the authenticated user can only update their own tasks
- The query `supabase.from('tasks').update({ deleted_at: ... }).eq('id', id)` will only succeed if the task belongs to the authenticated user
- No need for additional authorization checks beyond ensuring `id` matches a task owned by the user

**Supabase UPDATE Pattern:**
[Source: Story 2.3 implementation, architecture/database-schema-data-model.md]

The Supabase query pattern for updating tasks:

**Basic UPDATE Query:**
```typescript
const { data, error } = await supabase
  .from('tasks')
  .update({ deleted_at: new Date().toISOString() })
  .eq('id', id);

// Response on success: { 
//   data: [{ id, user_id, text, status, created_at, updated_at, deleted_at, ... }],
//   error: null 
// }

if (error) {
  // Handle error
  throw error;
}

// Note: For UPDATE operations, data array may be empty or contain updated row
// Success is indicated by error === null
```

**Query Details:**
- `.update({ deleted_at: timestamp })` - Sets deleted_at to current timestamp
- `.eq('id', id)` - Filters to specific task by ID
- RLS policy ensures user can only update their own tasks
- `updated_at` field is automatically updated by database trigger (if configured) or can be set manually

### State Management Architecture
[Source: architecture/offline-first-sync-architecture.md, src/stores/taskStore.ts]

**Zustand Store Pattern:**
The task store follows the Zustand pattern established in `authStore.ts` and `addTask`:
- Use `create` from `zustand` to create store
- Define TypeScript interface for store state and actions
- Use immutable updates for state (filter/map for arrays)
- Export custom hook: `useTaskStore`

**Current TaskStore Interface:**
[Source: src/stores/taskStore.ts]

```typescript
interface TaskStore {
  tasks: Task[];
  isLoading: boolean;
  loadError: string | null;
  addTask: (text: string) => Promise<void>;
  loadTasks: () => Promise<void>;
  // Need to add:
  // deleteTask: (id: string) => Promise<void>;
}
```

**Optimistic Update Pattern:**
[Source: Story 2.3 implementation, src/stores/taskStore.ts]

For Story 2.5, we implement optimistic delete:
```typescript
deleteTask: async (id: string) => {
  // Store original task for rollback
  const taskToDelete = get().tasks.find((t) => t.id === id);
  
  if (!taskToDelete) {
    // Task not found, nothing to delete
    return;
  }

  // Optimistic update: Remove from local state immediately
  set((state) => ({
    tasks: state.tasks.filter((t) => t.id !== id),
  }));

  try {
    // Get session and validate
    const session = useAuthStore.getState().session;
    if (!session?.user?.id) {
      throw new Error('No authenticated session found');
    }

    // Soft delete in Supabase
    const { error } = await supabase
      .from('tasks')
      .update({ deleted_at: new Date().toISOString() })
      .eq('id', id);

    if (error) {
      throw error;
    }

    // Success: Task already removed from local state
  } catch (error: any) {
    // Rollback: Restore task to list
    set((state) => ({
      tasks: [...state.tasks, taskToDelete].sort(
        (a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime()
      ),
    }));
    throw error; // Re-throw for UI error handling
  }
}
```

**Error Handling Pattern:**
- Optimistic update removes task immediately for instant UI feedback
- If Supabase call fails, task is restored to list (rollback)
- Error is thrown for UI to display error message
- User sees task disappear, then reappear if error occurs (acceptable UX for MVP)

### React Native Component Patterns
[Source: MainScreen.tsx, React Native documentation]

**Swipeable Component from react-native-gesture-handler:**
[Source: React Native Gesture Handler documentation]

React Native doesn't have built-in swipe gestures. Use `react-native-gesture-handler`:
```typescript
import { Swipeable } from 'react-native-gesture-handler';

<Swipeable
  renderRightActions={() => (
    <TouchableOpacity
      style={styles.deleteButton}
      onPress={() => handleDeleteTask(item.id)}
    >
      <Text style={styles.deleteButtonText}>Delete</Text>
    </TouchableOpacity>
  )}
>
  {/* Task item content */}
</Swipeable>
```

**Swipeable Configuration:**
- `renderRightActions` - Function that returns component to show when swiping left
- `renderLeftActions` - Function that returns component to show when swiping right (not needed for Story 2.5)
- `onSwipeableOpen` - Callback when swipe gesture completes (optional)
- `ref` - Can be stored to programmatically close swipe gesture

**Delete Button Styling:**
[Source: MainScreen.tsx patterns, design consistency]

Use consistent styling with existing buttons:
```typescript
const styles = StyleSheet.create({
  deleteButton: {
    backgroundColor: '#dc2626', // Red color (matches sign out button)
    justifyContent: 'center',
    alignItems: 'center',
    width: 80,
    height: '100%',
    borderRadius: 8,
  },
  deleteButtonText: {
    color: '#fff',
    fontSize: 16,
    fontWeight: '600',
  },
});
```

**Alert Confirmation Pattern:**
[Source: MainScreen.tsx patterns, React Native Alert documentation]

Use React Native `Alert.alert()` for confirmation:
```typescript
import { Alert } from 'react-native';

Alert.alert(
  'Delete Task',
  'Are you sure you want to delete this task?',
  [
    { text: 'Cancel', style: 'cancel', onPress: () => {} },
    {
      text: 'Delete',
      style: 'destructive',
      onPress: async () => {
        try {
          await deleteTask(id);
          // Success: Task already removed by optimistic update
        } catch (error: any) {
          Alert.alert(
            'Error',
            'Failed to delete task. Please try again.',
            [{ text: 'OK' }]
          );
        }
      },
    },
  ],
  { cancelable: true }
);
```

**Alert Button Styles:**
- `'cancel'` - iOS: Bold text, Android: Standard button
- `'destructive'` - iOS: Red text (warning), Android: Standard button (can style manually if needed)
- `cancelable: true` - Allows dismissing alert by tapping outside (iOS) or back button (Android)

**FlatList Integration:**
[Source: MainScreen.tsx, Story 2.4 implementation]

Swipeable should wrap the task item in `renderItem`:
```typescript
const renderTaskItem = ({ item }: { item: Task }) => {
  return (
    <Swipeable
      renderRightActions={() => (
        <TouchableOpacity
          style={styles.deleteButton}
          onPress={() => handleDeleteTask(item.id)}
        >
          <Text style={styles.deleteButtonText}>Delete</Text>
        </TouchableOpacity>
      )}
    >
      <View style={styles.taskItem}>
        <Text style={styles.taskText}>{item.text}</Text>
        <Text style={styles.taskTimestamp}>Just now</Text>
      </View>
    </Swipeable>
  );
};
```

### Error Handling
[Source: Story 2.3 implementation, Story 2.4 implementation, MainScreen.tsx patterns]

**Error Handling Flow:**
1. User swipes and taps Delete → Confirmation alert shown
2. User confirms → `deleteTask(id)` called
3. Store performs optimistic update (removes task)
4. Store calls Supabase UPDATE
5. If error: Store restores task, throws error
6. MainScreen catches error, shows error alert
7. User sees task reappear with error message

**Common Error Cases:**
1. **Network Error**: No internet connection → Supabase call fails → Task restored, error shown
2. **RLS Policy Violation**: Unauthorized access (should not happen) → Task restored, error shown
3. **Task Not Found**: Task already deleted or ID invalid → Store checks task exists before delete
4. **No Session**: User not authenticated → Error thrown, task restored

**Error Display:**
[Source: MainScreen.tsx patterns from Story 2.3]

Use `Alert.alert()` for error messages:
```typescript
Alert.alert(
  'Error',
  'Failed to delete task. Please try again.',
  [{ text: 'OK' }]
);
```

This pattern is consistent with error handling in `addTask` (Story 2.3).

### Testing Requirements
[Source: architecture/testing-strategy.md]

**Manual Testing:**
Story 2.5 focuses on manual testing:
- Unit tests not required for MVP story (testing framework setup is Story 1.2.5, optional)
- Manual verification of all acceptance criteria
- Cross-platform testing: iOS and Android (Expo)
- Test both success and error scenarios

**Test Scenarios:**
1. **Happy Path**: Swipe task left → Red Delete button appears → Tap Delete → Confirm → Task disappears immediately
2. **Cancel Delete**: Swipe task left → Tap Delete → Cancel → Task remains, swipe closes
3. **Error Handling**: Disable network → Swipe and delete → Confirm → Task disappears then reappears with error message
4. **Multiple Tasks**: Delete multiple tasks → Verify each deletion works independently
5. **Swipe Gesture**: Verify swipe works smoothly, doesn't conflict with FlatList scroll
6. **Data Verification**: Delete task → Close app → Reopen → Verify task doesn't appear (soft deleted in Supabase)
7. **Edge Cases**: Try to delete non-existent task (should handle gracefully), delete task while offline

### Project Structure Notes
[Source: Story 2.3, Story 2.4, docs/architecture]

**Directory Structure:**
- Source code: `src/`
- Stores: `src/stores/` - Zustand stores
- Screens: `src/screens/` - Screen components
- Libraries: `src/lib/` - Supabase client and utilities

**Files to Modify:**
- `src/stores/taskStore.ts` - Add `deleteTask` function
- `src/screens/MainScreen.tsx` - Add swipe gesture, confirmation alert, error handling

**Files to Check:**
- `package.json` - Verify `react-native-gesture-handler` is installed (may need to install if not present)

**File Organization:**
- Keep Supabase UPDATE logic in task store (separation of concerns)
- Swipe gesture and confirmation UI in MainScreen component
- Error handling in both store (rollback) and UI (error message)

### Known Constraints
- Story 2.5 uses soft delete (UPDATE deleted_at) - tasks are not permanently removed from database
- Hard delete (actual DELETE) can be implemented later if needed (admin function or cleanup job)
- Swipe gesture requires `react-native-gesture-handler` package (may need installation)
- Optimistic update may cause task to briefly disappear then reappear if delete fails (acceptable UX for MVP)
- Confirmation alert is required before deletion (prevents accidental deletions)
- Swipe gesture may conflict with pull-to-refresh on FlatList - ensure gestures don't interfere (test on both platforms)

### Dependencies
[Source: package.json check required]

**Required Package:**
- `react-native-gesture-handler` - For Swipeable component (may already be installed as Expo dependency)
  - If not installed: `npm install react-native-gesture-handler`
  - Follow setup instructions if needed (Expo projects typically auto-configure)

**Existing Dependencies:**
- `zustand` - Already used for state management
- `@supabase/supabase-js` - Already used for database operations
- `react-native` - Core framework

## Testing

**Manual Test Steps:**
1. Ensure app is running with authenticated session
2. Verify tasks exist in list (add tasks via Story 2.3 if needed)
3. Test swipe gesture: Swipe a task left → Verify red "Delete" button appears
4. Test cancel: Swipe left → Tap Delete → Tap Cancel in alert → Verify task remains, swipe closes
5. Test delete: Swipe left → Tap Delete → Tap Delete in confirmation → Verify task disappears immediately
6. Test error handling: Disable network → Swipe and delete → Verify error message, task reappears
7. Test data persistence: Delete task → Close app → Reopen → Verify task doesn't appear in list
8. Test multiple deletions: Delete several tasks → Verify each works independently
9. Test swipe gesture smoothness: Verify swipe doesn't conflict with FlatList scroll
10. Test with empty list: Delete all tasks → Verify empty state shows correctly

**Success Criteria:**
- Swipe left reveals red Delete button
- Confirmation alert appears before deletion
- Task removed from list immediately (optimistic update)
- Task soft-deleted in Supabase (deleted_at set)
- Error handling works: Failed delete restores task and shows error
- Swipe gesture works smoothly on iOS and Android
- No conflicts between swipe and pull-to-refresh gestures
- Deleted tasks don't reappear after app restart

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
_(To be filled by dev agent)_

### Debug Log References
_(To be filled by dev agent if needed)_

### Completion Notes List
_(To be filled by dev agent)_

### File List
_(To be filled by dev agent)_

## QA Results

_(To be filled by QA agent)_

